@model SIGESTEC.API.DTOs.TicketDTO
@{
    ViewData["Title"] = $"Detalle de Ticket #{Model.Id}";
}

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0"><i class="bi bi-ticket-detailed text-primary me-2"></i> @ViewData["Title"]</h2>
        <a asp-controller="Tickets" asp-action="MisSolicitudes" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> Volver a mis tickets
        </a>
    </div>

    <div class="row">
        <!-- Información Principal -->
        <div class="col-lg-8">
            <!-- Header del Ticket con Estado Destacado -->
            <div class="card shadow border-0 mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h4 class="text-primary mb-2">@Model.Titulo</h4>
                            <p class="text-muted mb-0">
                                <i class="bi bi-tag me-1"></i>@Model.TipoProblema
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <!-- Estado Principal Mejorado -->
                            <div class="d-flex flex-column align-items-end">
                                @if (Model.Estado == "Cancelado")
                                {
                                    <div class="alert alert-danger py-2 px-3 mb-2" role="alert">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-x-circle-fill me-2 fs-5"></i>
                                            <strong class="fs-6">TICKET CANCELADO</strong>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <span class="badge @GetStatusBadge(Model.Estado) fs-6 mb-2">@Model.Estado</span>
                                }
                                <span class="badge @GetPriorityBadge(Model.Prioridad)">@Model.Prioridad</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Descripción -->
            <div class="card shadow border-0 mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0"><i class="bi bi-card-text me-2"></i>Descripción del Problema</h5>
                </div>
                <div class="card-body">
                    <div class="bg-light p-4 rounded">
                        <p class="mb-0">@Model.Descripcion</p>
                    </div>
                </div>
            </div>

            <!-- Línea de Tiempo -->
            <div class="card shadow border-0 mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i>Línea de Tiempo</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <!-- Creación -->
                        <div class="timeline-item">
                            <div class="timeline-marker bg-primary">
                                <i class="bi bi-plus-circle"></i>
                            </div>
                            <div class="timeline-content">
                                <h6 class="mb-1">Ticket Creado</h6>
                                <p class="mb-1 text-muted">@Model.FechaCreacion.ToString("dddd, dd MMMM yyyy 'a las' hh:mm tt")</p>
                                <small class="text-muted">Hace @GetTiempoTranscurrido(Model.FechaCreacion)</small>
                            </div>
                        </div>

                        <!-- Asignación -->
                        @if (Model.FechaAsignacion.HasValue)
                        {
                            <div class="timeline-item">
                                <div class="timeline-marker bg-info">
                                    <i class="bi bi-person-check"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6 class="mb-1">Asignado a Técnico</h6>
                                    <p class="mb-1 text-muted">@Model.FechaAsignacion.Value.ToString("dddd, dd MMMM yyyy 'a las' hh:mm tt")</p>
                                    <small class="text-muted">Asignado hace @GetTiempoTranscurrido(Model.FechaAsignacion.Value)</small>
                                    @if (!string.IsNullOrEmpty(Model.TecnicoNombre) && Model.TecnicoNombre != "No asignado")
                                    {
                                        <div class="mt-1">
                                            <span class="badge bg-info">@Model.TecnicoNombre</span>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        <!-- Resolución o Cancelación -->
                        @if (Model.FechaResolucion.HasValue)
                        {
                            <div class="timeline-item">
                                @if (Model.Estado == "Terminado")
                                {
                                    <div class="timeline-marker bg-success">
                                        <i class="bi bi-check-circle"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1">Ticket Resuelto</h6>
                                        <p class="mb-1 text-muted">@Model.FechaResolucion.Value.ToString("dddd, dd MMMM yyyy 'a las' hh:mm tt")</p>
                                        <small class="text-muted">@GetTiempoResolucion(Model.TiempoResolucion)</small>
                                    </div>
                                }
                                else if (Model.Estado == "Cancelado")
                                {
                                    <div class="timeline-marker bg-danger">
                                        <i class="bi bi-x-circle"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <h6 class="mb-1 text-danger">Ticket Cancelado</h6>
                                        <p class="mb-1 text-muted">@Model.FechaResolucion.Value.ToString("dddd, dd MMMM yyyy 'a las' hh:mm tt")</p>
                                        <small class="text-muted">Cancelado hace @GetTiempoTranscurrido(Model.FechaResolucion.Value)</small>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Comentario de Resolución -->
            @if (!string.IsNullOrEmpty(Model.ComentarioResolucion))
            {
                <div class="card shadow border-0 mb-4">
                    <div class="card-header bg-success text-white py-3">
                        <h5 class="mb-0"><i class="bi bi-check-circle me-2"></i> Solución Aplicada</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-success border-0">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="bi bi-info-circle-fill fs-4"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="alert-heading">Solución registrada</h6>
                                    <p class="mb-0">@Model.ComentarioResolucion</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Comentario de Cancelación - MEJORADO -->
            @if (!string.IsNullOrEmpty(Model.ComentarioCancelacion))
            {
                <div class="card shadow border-0 border-danger">
                    <div class="card-header bg-danger text-white py-3">
                        <h5 class="mb-0"><i class="bi bi-x-octagon me-2"></i> Información de Cancelación</h5>
                    </div>
                    <div class="card-body">
                        <!-- Alerta de Cancelación -->
                        <div class="alert alert-danger border-0 mb-4">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="alert-heading">Este ticket ha sido cancelado</h6>
                                    <p class="mb-0">El ticket fue cancelado y no recibirá más atención del equipo de soporte.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Información Detallada de Cancelación -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-danger">Motivo de Cancelación:</label>
                                    <div class="bg-danger bg-opacity-10 p-3 rounded border-start border-4 border-danger">
                                        <p class="mb-0">@Model.ComentarioCancelacion</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-danger">Cancelado por:</label>
                                    <div class="d-flex align-items-center bg-light p-3 rounded">
                                        <div class="flex-shrink-0">
                                            <div class="bg-danger text-white rounded-circle d-flex align-items-center justify-content-center"
                                                 style="width: 40px; height: 40px;">
                                                <i class="bi bi-person-x"></i>
                                            </div>
                                        </div>
                                        <div class="flex-grow-1 ms-3">
                                            <strong class="d-block">@Model.CanceladoPor</strong>
                                            <small class="text-muted">
                                                @if (Model.CanceladoPor == Model.UsuarioNombre)
                                                {
                                                    <span>Usuario Solicitante</span>
                                                }
                                                else if (Model.CanceladoPor == Model.TecnicoNombre)
                                                {
                                                    <span>Técnico Asignado</span>
                                                }
                                                else
                                                {
                                                    <span>Administrador</span>
                                                }
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Estadísticas de Cancelación -->
                        <div class="bg-light p-3 rounded mt-3">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="border-end">
                                        <div class="text-danger fw-bold fs-5">#@Model.Id</div>
                                        <small class="text-muted">Ticket ID</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="border-end">
                                        <div class="text-danger fw-bold fs-5">@GetDuracionTotal()</div>
                                        <small class="text-muted">Duración Total</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div>
                                        <div class="text-danger fw-bold fs-5">@Model.Prioridad</div>
                                        <small class="text-muted">Prioridad</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Panel Lateral -->
        <div class="col-lg-4">
            <!-- Información del Usuario -->
            <div class="card shadow border-0 mb-4">
                <div class="card-header bg-info text-white py-3">
                    <h5 class="mb-0"><i class="bi bi-person me-2"></i> Usuario Solicitante</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        @if (!string.IsNullOrEmpty(Model.UsuarioFotoPerfil))
                        {
                            <img src="@Model.UsuarioFotoPerfil"
                                 class="rounded-circle img-thumbnail user-avatar"
                                 alt="@Model.UsuarioNombre"
                                 style="width: 80px; height: 80px; object-fit: cover;"
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiByeD0iNDAiIGZpbGw9IiMwZTZmZmYiLz4KPHRleHQgeD0iNDAiIHk9IjQ1IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSIyNCIgZm9udC13ZWlnaHQ9ImJvbGQiPkBHZXRJbmljaWFscyhNb2RlbC5Vc3VhcmlvTm9tYnJlKTwvdGV4dD4KPC9zdmc+'">
                        }
                        else
                        {
                            <div class="rounded-circle bg-info d-inline-flex align-items-center justify-content-center text-white avatar-placeholder"
                                 style="width: 80px; height: 80px; font-size: 1.5rem; font-weight: bold;">
                                @GetIniciales(Model.UsuarioNombre)
                            </div>
                        }
                    </div>
                    <div class="mb-3">
                        <strong>Nombre:</strong>
                        <p class="mb-0">@Model.UsuarioNombre</p>
                    </div>
                    <div class="mb-3">
                        <strong>Email:</strong>
                        <p class="mb-0">
                            <a href="mailto:@Model.UsuarioEmail" class="text-decoration-none">
                                <i class="bi bi-envelope me-1"></i>@Model.UsuarioEmail
                            </a>
                        </p>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.UsuarioDepartamento) && Model.UsuarioDepartamento != "N/A")
                    {
                        <div class="mb-3">
                            <strong>Departamento:</strong>
                            <p class="mb-0">@Model.UsuarioDepartamento</p>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(Model.UsuarioTelefono) && Model.UsuarioTelefono != "N/A")
                    {
                        <div class="mb-3">
                            <strong>Teléfono:</strong>
                            <p class="mb-0">
                                <a href="tel:@Model.UsuarioTelefono" class="text-decoration-none">
                                    <i class="bi bi-telephone me-1"></i>@Model.UsuarioTelefono
                                </a>
                            </p>
                        </div>
                    }
                </div>
            </div>

            <!-- Información del Técnico -->
            <div class="card shadow border-0 mb-4">
                <div class="card-header bg-warning text-dark py-3">
                    <h5 class="mb-0"><i class="bi bi-tools me-2"></i> Técnico Asignado</h5>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(Model.TecnicoNombre) && Model.TecnicoNombre != "No asignado")
                    {
                        <div class="text-center mb-3">
                            @if (!string.IsNullOrEmpty(Model.TecnicoFotoPerfil))
                            {
                                <img src="@Model.TecnicoFotoPerfil"
                                     class="rounded-circle img-thumbnail user-avatar"
                                     alt="@Model.TecnicoNombre"
                                     style="width: 80px; height: 80px; object-fit: cover;"
                                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiByeD0iNDAiIGZpbGw9IiNmZjk4MDAiLz4KPHRleHQgeD0iNDAiIHk9IjQ1IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSIgZm9udC1zaXplPSIyNCIgZm9udC13ZWlnaHQ9ImJvbGQiPkBHZXRJbmljaWFscyhNb2RlbC5UZWNuaWNvTm9tYnJlKTwvdGV4dD4KPC9zdmc+'">
                            }
                            else
                            {
                                <div class="rounded-circle bg-warning d-inline-flex align-items-center justify-content-center text-dark avatar-placeholder"
                                     style="width: 80px; height: 80px; font-size: 1.5rem; font-weight: bold;">
                                    @GetIniciales(Model.TecnicoNombre)
                                </div>
                            }
                        </div>
                        <div class="mb-3">
                            <strong>Nombre:</strong>
                            <p class="mb-0">@Model.TecnicoNombre</p>
                        </div>
                        <div class="mb-3">
                            <strong>Email:</strong>
                            <p class="mb-0">
                                <a href="mailto:@Model.TecnicoEmail" class="text-decoration-none">
                                    <i class="bi bi-envelope me-1"></i>@Model.TecnicoEmail
                                </a>
                            </p>
                        </div>
                        @if (!string.IsNullOrEmpty(Model.TecnicoEspecialidad) && Model.TecnicoEspecialidad != "N/A")
                        {
                            <div class="mb-3">
                                <strong>Especialidad:</strong>
                                <p class="mb-0">@Model.TecnicoEspecialidad</p>
                            </div>
                        }
                        @if (Model.FechaAsignacion.HasValue)
                        {
                            <div class="mb-3">
                                <strong>Asignado el:</strong>
                                <p class="mb-0">@Model.FechaAsignacion.Value.ToString("dd/MM/yyyy HH:mm")</p>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center text-muted py-3">
                            <div class="rounded-circle bg-secondary d-inline-flex align-items-center justify-content-center text-white mb-3"
                                 style="width: 80px; height: 80px; font-size: 2rem;">
                                <i class="bi bi-person-x"></i>
                            </div>
                            <p class="mt-2 mb-0">Esperando asignación de técnico</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Acciones -->
            <div class="card shadow border-0">
                <div class="card-header bg-light py-3">
                    <h5 class="mb-0"><i class="bi bi-lightning me-2"></i> Acciones</h5>
                </div>
                <div class="card-body">
                    @if (Model.Estado == "En espera" || Model.Estado == "En progreso")
                    {
                        <a asp-controller="Tickets" asp-action="CancelarConfirmacion" asp-route-id="@Model.Id"
                           class="btn btn-danger w-100 mb-2">
                            <i class="bi bi-x-circle me-1"></i> Cancelar Ticket
                        </a>
                    }
                    else if (Model.Estado == "Cancelado")
                    {
                        <div class="alert alert-warning text-center py-2">
                            <small><i class="bi bi-info-circle me-1"></i>Este ticket está cancelado</small>
                        </div>
                    }

                    @if (User.IsInRole("Tecnico") && Model.Estado == "En espera")
                    {
                        <form asp-controller="Tecnico" asp-action="Asignar" method="post" class="d-inline w-100">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" class="btn btn-primary w-100 mb-2">
                                <i class="bi bi-person-plus me-1"></i> Asignarme este Ticket
                            </button>
                        </form>
                    }

                    @if (User.IsInRole("Tecnico") && Model.Estado == "En progreso")
                    {
                        <button type="button" class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#resolverModal">
                            <i class="bi bi-check-circle me-1"></i> Marcar como Resuelto
                        </button>
                    }

                    <!-- BOTÓN DE HISTORIAL - VISIBLE PARA ADMIN Y TÉCNICOS -->
                    @if (User.IsInRole("Admin") || User.IsInRole("Tecnico"))
                    {
                        <button type="button" class="btn btn-outline-secondary w-100 mt-2" data-bs-toggle="modal" data-bs-target="#historialUsuarioModal" onclick="cargarHistorialUsuario(@Model.Id)">
                            <i class="bi bi-clock-history me-1"></i> Historial del Usuario
                        </button>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Resolver Ticket (Solo para Técnicos) -->
@if (User.IsInRole("Tecnico") && Model.Estado == "En progreso")
{
    <div class="modal fade" id="resolverModal" tabindex="-1" aria-labelledby="resolverModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resolverModalLabel">Resolver Ticket #@Model.Id</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form asp-controller="Tecnico" asp-action="Resolver" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Id" />
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Descripción de la Solución *</label>
                            <textarea name="comentario" class="form-control" rows="4"
                                  placeholder="Describe detalladamente cómo solucionaste el problema..."
                                  required maxlength="500"></textarea>
                            <div class="form-text">
                                Esta información será visible para el usuario y quedará registrada en el historial.
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle me-1"></i> Confirmar Resolución
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<!-- ✅ MODAL PARA HISTORIAL DEL USUARIO (AGREGADO) -->
@if (User.IsInRole("Admin") || User.IsInRole("Tecnico"))
{
    <div class="modal fade" id="historialUsuarioModal" tabindex="-1" aria-labelledby="historialUsuarioModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="historialUsuarioModalLabel">
                        <i class="bi bi-person-lines-fill me-2"></i>Historial de Tickets del Usuario
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h6 class="mb-1" id="nombreUsuarioLabel">Cargando...</h6>
                            <small class="text-muted">Todos los tickets creados por este usuario</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-primary fs-6" id="totalTicketsLabel">-</span>
                            <div class="text-muted small">Total de tickets</div>
                        </div>
                    </div>

                    <div id="historialUsuarioLoading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando historial...</span>
                        </div>
                        <p class="mt-2 text-muted">Cargando historial del usuario...</p>
                    </div>

                    <div id="historialUsuarioContent" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Título</th>
                                        <th>Tipo</th>
                                        <th>Estado</th>
                                        <th>Prioridad</th>
                                        <th>Fecha Creación</th>
                                        <th>Técnico</th>
                                        <th>Tiempo Resolución</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="historialUsuarioTable">
                                    <!-- Los tickets se cargarán aquí via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="historialUsuarioEmpty" class="text-center py-5" style="display: none;">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <h5 class="text-muted mt-3">No hay tickets registrados</h5>
                        <p class="text-muted">Este usuario no ha creado ningún ticket aún.</p>
                    </div>

                    <div id="historialUsuarioError" class="text-center py-5" style="display: none;">
                        <i class="bi bi-exclamation-triangle display-1 text-danger"></i>
                        <h5 class="text-danger mt-3">Error al cargar el historial</h5>
                        <p class="text-muted">No se pudo cargar el historial del usuario. Intente nuevamente.</p>
                        <button type="button" class="btn btn-primary mt-2" onclick="cargarHistorialUsuario(@Model.Id)">
                            <i class="bi bi-arrow-clockwise me-1"></i> Reintentar
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        $(document).ready(function() {
            // Contador de caracteres para el modal de resolución
            $('#resolverModal textarea').on('input', function() {
                const length = $(this).val().length;
                const maxLength = $(this).attr('maxlength');
                $('#resolverModal .form-text').text(length + '/' + maxLength + ' caracteres');
            });

            // Validar formulario de resolución
            $('#resolverModal form').on('submit', function() {
                const comentario = $(this).find('textarea[name="comentario"]');
                if (!comentario.val().trim()) {
                    alert('Por favor, describa la solución aplicada.');
                    return false;
                }
                return true;
            });

            // Mostrar mensajes de TempData
            @if (TempData["SuccessMessage"] != null)
            {
                        <text>
                        showToast('Éxito', '@TempData["SuccessMessage"]', 'success');
                        </text>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                        <text>
                        showToast('Error', '@TempData["ErrorMessage"]', 'error');
                        </text>
            }

            // Limpiar el modal cuando se cierre
            $('#historialUsuarioModal').on('hidden.bs.modal', function () {
                $('#historialUsuarioTable').empty();
                $('#historialUsuarioLoading').show();
                $('#historialUsuarioContent').hide();
                $('#historialUsuarioEmpty').hide();
                $('#historialUsuarioError').hide();
            });
        });

        function cargarHistorialUsuario(ticketId) {
            // Mostrar loading
            $('#historialUsuarioLoading').show();
            $('#historialUsuarioContent').hide();
            $('#historialUsuarioEmpty').hide();
            $('#historialUsuarioError').hide();

            $.get('/Tickets/ObtenerHistorialUsuario?id=' + ticketId, function(response) {
                $('#historialUsuarioLoading').hide();

                if (response.success) {
                    const historial = response.data;
                    const usuarioSolicitante = response.usuarioSolicitante;

                    // Actualizar información del usuario
                    $('#nombreUsuarioLabel').text(usuarioSolicitante);
                    $('#totalTicketsLabel').text(historial.length);

                    if (historial.length > 0) {
                        // Ordenar por fecha (más reciente primero)
                        historial.sort((a, b) => new Date(b.fechaCreacion) - new Date(a.fechaCreacion));

                        const tableBody = $('#historialUsuarioTable');
                        tableBody.empty();

                        historial.forEach(ticket => {
                            const tableRow = crearFilaTicket(ticket, ticketId);
                            tableBody.append(tableRow);
                        });

                        $('#historialUsuarioContent').show();
                    } else {
                        $('#historialUsuarioEmpty').show();
                    }
                } else {
                    $('#historialUsuarioError').show();
                }
            }).fail(function() {
                $('#historialUsuarioLoading').hide();
                $('#historialUsuarioError').show();
            });
        }

        function crearFilaTicket(ticket, ticketActualId) {
            const fechaCreacion = new Date(ticket.fechaCreacion);
            const fechaFormateada = fechaCreacion.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const tiempoResolucion = ticket.tiempoResolucion ?
                formatearTiempoResolucion(ticket.tiempoResolucion) : 'N/A';

            const esTicketActual = ticket.ticketId === ticketActualId;
            const filaClase = esTicketActual ? 'table-active fw-bold' : '';

            const badgeEstado = obtenerBadgeEstado(ticket.estado);
            const badgePrioridad = obtenerBadgePrioridad(ticket.prioridad);

            return `
                <tr class="${filaClase}">
                    <td>
                        ${ticket.ticketId}
                        ${esTicketActual ? '<span class="badge bg-primary ms-1">Actual</span>' : ''}
                    </td>
                    <td>
                        <div class="fw-semibold">${ticket.titulo}</div>
                        <small class="text-muted">${ticket.tipoProblema}</small>
                    </td>
                    <td>${ticket.tipoProblema}</td>
                    <td><span class="badge ${badgeEstado}">${ticket.estado}</span></td>
                    <td><span class="badge ${badgePrioridad}">${ticket.prioridad}</span></td>
                    <td>
                        <small>${fechaFormateada}</small>
                        <br>
                        <small class="text-muted">Hace ${calcularTiempoTranscurrido(fechaCreacion)}</small>
                    </td>
                    <td>${ticket.tecnicoAsignado}</td>
                    <td>${tiempoResolucion}</td>
                    <td>
                        <a href="/Tickets/Detalle/${ticket.ticketId}" class="btn btn-sm btn-outline-primary" target="_blank">
                            <i class="bi bi-eye"></i>
                        </a>
                    </td>
                </tr>
            `;
        }

        function formatearTiempoResolucion(tiempo) {
            // Convertir el objeto TimeSpan a horas y minutos
            const totalSegundos = tiempo.totalSeconds || tiempo.ticks / 10000000; // .NET ticks to seconds
            const horas = Math.floor(totalSegundos / 3600);
            const minutos = Math.floor((totalSegundos % 3600) / 60);

            if (horas > 0) {
                return `${horas}h ${minutos}m`;
            } else if (minutos > 0) {
                return `${minutos}m`;
            } else {
                return '< 1m';
            }
        }

        function calcularTiempoTranscurrido(fecha) {
            const ahora = new Date();
            const diferencia = ahora - fecha;
            const dias = Math.floor(diferencia / (1000 * 60 * 60 * 24));
            const horas = Math.floor((diferencia % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutos = Math.floor((diferencia % (1000 * 60 * 60)) / (1000 * 60));

            if (dias > 0) {
                return `${dias} día${dias > 1 ? 's' : ''}`;
            } else if (horas > 0) {
                return `${horas} hora${horas > 1 ? 's' : ''}`;
            } else {
                return `${minutos} minuto${minutos > 1 ? 's' : ''}`;
            }
        }

        function obtenerBadgeEstado(estado) {
            switch(estado.toLowerCase()) {
                case 'terminado':
                case 'resuelto':
                    return 'bg-success';
                case 'cancelado':
                    return 'bg-danger';
                case 'en progreso':
                case 'en proceso':
                    return 'bg-primary';
                case 'asignado':
                    return 'bg-info';
                default:
                    return 'bg-warning text-dark';
            }
        }

        function obtenerBadgePrioridad(prioridad) {
            switch(prioridad.toLowerCase()) {
                case 'alta':
                    return 'bg-danger';
                case 'media':
                    return 'bg-warning text-dark';
                case 'baja':
                    return 'bg-success';
                default:
                    return 'bg-secondary';
            }
        }

        function showToast(title, message, type) {
            const toast = $(`
                <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            <strong>${title}:</strong> ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `);
            $('#toastContainer').append(toast);
            new bootstrap.Toast(toast[0]).show();
        }
    </script>
}

<style>
    .user-avatar {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border: 3px solid #dee2e6;
        transition: transform 0.3s ease;
    }

        .user-avatar:hover {
            transform: scale(1.05);
        }

    .avatar-placeholder {
        width: 80px;
        height: 80px;
        border: 3px solid #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        transition: all 0.3s ease;
    }

        .avatar-placeholder:hover {
            border-color: #6c757d;
        }

    .card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1) !important;
        }

    .badge {
        font-size: 0.8em;
    }

    /* Estilos para la tabla en el modal */
    .table th {
        border-top: none;
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .table td {
        vertical-align: middle;
    }

    .table-active {
        background-color: rgba(0, 123, 255, 0.1) !important;
    }

    /* Scroll personalizado para el modal */
    .modal-body {
        max-height: 70vh;
        overflow-y: auto;
    }

    .table-responsive {
        max-height: 400px;
        overflow-y: auto;
    }

    /* Estilos para la línea de tiempo */
    .timeline {
        position: relative;
        padding-left: 30px;
    }

    .timeline-item {
        position: relative;
        margin-bottom: 25px;
    }

    .timeline-marker {
        position: absolute;
        left: -30px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
    }

    .timeline-content {
        padding-left: 15px;
    }

    .timeline-item:not(:last-child)::after {
        content: '';
        position: absolute;
        left: -18px;
        top: 24px;
        bottom: -25px;
        width: 2px;
        background-color: #dee2e6;
    }

    /* Estilos específicos para tickets cancelados */
    .card.border-danger {
        border: 2px solid #dc3545 !important;
    }

    .alert-danger {
        border-left: 4px solid #dc3545;
    }

    .border-danger {
        border-color: #dc3545 !important;
    }
</style>

<!-- Container para toasts -->
<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>

@functions {
    string GetPriorityBadge(string prioridad)
    {
        return prioridad?.ToLower() switch
        {
            "alta" => "bg-danger",
            "media" => "bg-warning text-dark",
            "baja" => "bg-success",
            _ => "bg-secondary"
        };
    }

    string GetStatusBadge(string estado)
    {
        return estado?.ToLower() switch
        {
            "resuelto" => "bg-success",
            "terminado" => "bg-success",
            "cancelado" => "bg-danger",
            "en progreso" => "bg-primary",
            "en proceso" => "bg-primary",
            "asignado" => "bg-info",
            _ => "bg-warning text-dark"
        };
    }

    string GetTiempoTranscurrido(DateTime fecha)
    {
        var fechaLocal = fecha.Kind == DateTimeKind.Utc ? fecha.ToLocalTime() : fecha;
        var tiempo = DateTime.Now - fechaLocal;

        if (tiempo.TotalDays >= 1)
        {
            return $"{(int)tiempo.TotalDays} día{(tiempo.TotalDays >= 2 ? "s" : "")}";
        }
        else if (tiempo.TotalHours >= 1)
        {
            return $"{(int)tiempo.TotalHours} hora{(tiempo.TotalHours >= 2 ? "s" : "")}";
        }
        else
        {
            return $"{(int)tiempo.TotalMinutes} minuto{(tiempo.TotalMinutes >= 2 ? "s" : "")}";
        }
    }

    string GetTiempoResolucion(TimeSpan? tiempo)
    {
        if (!tiempo.HasValue) return "N/A";

        var t = tiempo.Value;
        if (t.TotalDays >= 1)
        {
            return $"Resuelto en {(int)t.TotalDays}d {t.Hours}h {t.Minutes}m";
        }
        else if (t.TotalHours >= 1)
        {
            return $"Resuelto en {(int)t.TotalHours}h {t.Minutes}m";
        }
        else
        {
            return $"Resuelto en {t.Minutes}m";
        }
    }

    string GetIniciales(string nombreCompleto)
    {
        if (string.IsNullOrEmpty(nombreCompleto))
            return "U";

        var partes = nombreCompleto.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (partes.Length >= 2)
            return $"{partes[0][0]}{partes[1][0]}".ToUpper();
        else if (partes.Length == 1)
            return partes[0][0].ToString().ToUpper();
        else
            return "U";
    }

    string GetDuracionTotal()
    {
        var fechaFin = Model.FechaResolucion ?? DateTime.Now;
        var duracion = fechaFin - Model.FechaCreacion;

        if (duracion.TotalDays >= 1)
        {
            return $"{(int)duracion.TotalDays}d {(int)duracion.Hours}h";
        }
        else if (duracion.TotalHours >= 1)
        {
            return $"{(int)duracion.TotalHours}h {(int)duracion.Minutes}m";
        }
        else
        {
            return $"{(int)duracion.TotalMinutes}m";
        }
    }
}