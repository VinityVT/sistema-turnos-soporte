@model SIGESTEC.API.DTOs.TicketCreacionDTO
@{
    ViewData["Title"] = "Nueva Solicitud de Soporte";
}

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow border-0 mt-4">
                <div class="card-header bg-primary text-white py-3">
                    <h2 class="h5 mb-0"><i class="bi bi-plus-circle me-2"></i> @ViewData["Title"]</h2>
                </div>
                <div class="card-body">
                    <!-- Progreso del formulario -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1 me-3" style="height: 8px;">
                                <div class="progress-bar" id="formProgress" style="width: 0%"></div>
                            </div>
                            <small class="text-muted" id="progressText">0% completado</small>
                        </div>
                    </div>

                    <form id="ticketForm" method="post">
                        @Html.AntiForgeryToken()

                        <!-- Alertas de validación del lado del cliente -->
                        <div id="clientValidationSummary" class="alert alert-danger" style="display: none;">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <span id="validationMessage">Por favor, corrija los siguientes errores:</span>
                        </div>

                        <!-- Información de la Solicitud -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-info-circle text-primary me-2"></i>Información de la Solicitud
                            </h5>

                            <div class="mb-4">
                                <div class="form-floating">
                                    <input asp-for="Titulo" class="form-control" placeholder=" " required />
                                    <label asp-for="Titulo" class="fw-semibold">Título de la Solicitud *</label>
                                    <div class="form-text">Resumen breve y claro del problema</div>
                                    <span class="text-danger small" id="TituloError"></span>
                                </div>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <select asp-for="TipoProblema" class="form-select" required>
                                            <option value="" selected disabled>Seleccionar...</option>
                                            <option value="Impresora">🖨️ Impresora</option>
                                            <option value="Red">🌐 Red</option>
                                            <option value="Software">💻 Software</option>
                                            <option value="Hardware">🔧 Hardware</option>
                                            <option value="Internet">📡 Internet</option>
                                            <option value="Equipo lento">⚡ Equipo lento</option>
                                        </select>
                                        <label asp-for="TipoProblema" class="fw-semibold">Tipo de Problema *</label>
                                        <span class="text-danger small" id="TipoProblemaError"></span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <select asp-for="Prioridad" class="form-select" required>
                                            <option value="Baja">🟢 Baja (1-2 días)</option>
                                            <option value="Media" selected>🟡 Media (Resolver hoy)</option>
                                            <option value="Alta">🔴 Alta (Urgente)</option>
                                        </select>
                                        <label asp-for="Prioridad" class="fw-semibold">Nivel de Prioridad *</label>
                                        <span class="text-danger small" id="PrioridadError"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Descripción Detallada -->
                        <div class="mb-4">
                            <h5 class="border-bottom pb-2 mb-3">
                                <i class="bi bi-card-text text-primary me-2"></i>Descripción Detallada
                            </h5>

                            <div class="form-floating">
                                <textarea asp-for="Descripcion" class="form-control" placeholder=" "
                                          style="height: 150px" required></textarea>
                                <label asp-for="Descripcion" class="fw-semibold">Descripción del Problema *</label>
                                <div class="form-text">
                                    <i class="bi bi-lightbulb me-1"></i>
                                    Describa el problema con el mayor detalle posible, incluyendo:
                                    <ul class="small mt-1 mb-0">
                                        <li>Pasos para reproducir el problema</li>
                                        <li>Mensajes de error específicos</li>
                                        <li>Cuándo comenzó el problema</li>
                                        <li>Equipos o software involucrados</li>
                                    </ul>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <span id="caracteresCount">0</span> caracteres escritos
                                    </small>
                                </div>
                                <span class="text-danger small" id="DescripcionError"></span>
                            </div>
                        </div>

                        <!-- Resumen antes de enviar -->
                        <div class="card bg-light border-0 mb-4" id="resumenCard" style="display: none;">
                            <div class="card-body">
                                <h6 class="card-title mb-3">
                                    <i class="bi bi-check-circle text-success me-2"></i>Resumen de la Solicitud
                                </h6>
                                <div class="row small">
                                    <div class="col-md-6">
                                        <strong>Título:</strong> <span id="resumenTitulo">-</span><br>
                                        <strong>Tipo:</strong> <span id="resumenTipo">-</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Prioridad:</strong> <span id="resumenPrioridad">-</span><br>
                                        <strong>Caracteres:</strong> <span id="resumenCaracteres">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4 pt-3 border-top">
                            <a asp-controller="Tickets" asp-action="MisSolicitudes" class="btn btn-outline-secondary me-md-2">
                                <i class="bi bi-arrow-left me-1"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary" id="submitButton">
                                <i class="bi bi-send me-1"></i> Enviar Solicitud
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Carga -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-body text-center p-5">
                <div class="mb-3">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
                <h6 class="mb-2">Procesando...</h6>
                <p id="loadingModalMessage" class="text-muted mb-0 small">Por favor espere</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Éxito/Error -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-body text-center p-5">
                <div class="mb-4">
                    <i class="bi bi-check-circle-fill text-success display-4" id="successModalIcon"></i>
                </div>
                <h5 id="successModalTitle" class="mb-3">¡Éxito!</h5>
                <p id="successModalMessage" class="text-muted mb-4">La operación se completó correctamente.</p>
                <button type="button" class="btn btn-success w-100" id="successModalButton" data-bs-dismiss="modal">
                    <i class="bi bi-check-lg me-2"></i>Aceptar
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function() {
            // Inicializar contadores
            actualizarContadorCaracteres();
            actualizarProgreso();
            actualizarResumen();

            // Eventos para actualización en tiempo real
            $('#Titulo, #TipoProblema, #Prioridad, #Descripcion').on('input change', function() {
                actualizarContadorCaracteres();
                actualizarProgreso();
                actualizarResumen();

                // Remover clase de error si tiene valor
                if ($(this).val().trim()) {
                    $(this).removeClass('is-invalid');
                    $(this).next('.text-danger').text('');
                }
            });

            // Envío del formulario con AJAX
            $('#ticketForm').on('submit', function(e) {
                e.preventDefault();

                if (validarFormulario()) {
                    enviarFormulario();
                }
            });
        });

        function validarFormulario() {
            let isValid = true;
            let errorFields = [];

            // Limpiar errores anteriores
            $('.is-invalid').removeClass('is-invalid');
            $('.text-danger').text('');
            $('#clientValidationSummary').hide();

            // Validar campos requeridos
            const campos = [
                { id: '#Titulo', errorId: '#TituloError', nombre: 'Título' },
                { id: '#TipoProblema', errorId: '#TipoProblemaError', nombre: 'Tipo de Problema' },
                { id: '#Prioridad', errorId: '#PrioridadError', nombre: 'Prioridad' },
                { id: '#Descripcion', errorId: '#DescripcionError', nombre: 'Descripción' }
            ];

            campos.forEach(campo => {
                const $elemento = $(campo.id);
                const valor = $elemento.val() ? $elemento.val().trim() : '';

                if (!valor) {
                    $elemento.addClass('is-invalid');
                    $(campo.errorId).text(`El campo ${campo.nombre} es requerido.`);
                    errorFields.push(campo.nombre);
                    isValid = false;
                }
            });

            if (!isValid) {
                $('#validationMessage').html(
                    `Por favor, complete los siguientes campos requeridos: <strong>${errorFields.join(', ')}</strong>`
                );
                $('#clientValidationSummary').show();
            }

            return isValid;
        }

        function enviarFormulario() {
            // Mostrar modal de carga
            showLoadingModal('Creando solicitud de soporte...');

            // Preparar datos del formulario
            const formData = new FormData();
            formData.append('Titulo', $('#Titulo').val());
            formData.append('TipoProblema', $('#TipoProblema').val());
            formData.append('Prioridad', $('#Prioridad').val());
            formData.append('Descripcion', $('#Descripcion').val());
            formData.append('__RequestVerificationToken', $('input[name="__RequestVerificationToken"]').val());

            // Enviar vía AJAX
            fetch('@Url.Action("Crear", "Tickets")', {
                method: 'POST',
                body: formData,
                headers: {
                    'Accept': 'application/json',
                    'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .then(data => {
                hideLoadingModal();

                if (data.success) {
                    showSuccessModal('Solicitud Creada', 'La solicitud de soporte se ha creado exitosamente.');

                    // Redirigir después de cerrar el modal
                    $('#successModal').on('hidden.bs.modal', function () {
                        window.location.href = data.redirectUrl || '@Url.Action("MisSolicitudes", "Tickets")';
                    });
                } else {
                    // Mostrar errores del servidor
                    mostrarErroresServidor(data.errors);
                }
            })
            .catch(error => {
                hideLoadingModal();
                showErrorModal('Error', 'No se pudo crear la solicitud. Intente nuevamente.');
                console.error('Error:', error);
            });
        }

        function mostrarErroresServidor(errors) {
            if (errors && typeof errors === 'object') {
                let errorMessages = [];

                // Mostrar errores específicos por campo
                Object.keys(errors).forEach(key => {
                    const errorId = `#${key}Error`;
                    const errorMessage = Array.isArray(errors[key]) ? errors[key][0] : errors[key];

                    if ($(errorId).length) {
                        $(errorId).text(errorMessage);
                        $(`#${key}`).addClass('is-invalid');
                    }
                    errorMessages.push(errorMessage);
                });

                if (errorMessages.length > 0) {
                    $('#validationMessage').html(
                        `Por favor, corrija los siguientes errores:<br><strong>${errorMessages.join('<br>')}</strong>`
                    );
                    $('#clientValidationSummary').show();
                }
            } else {
                showErrorModal('Error', 'Ocurrió un error inesperado al procesar la solicitud.');
            }
        }

        function actualizarContadorCaracteres() {
            const descripcion = $('#Descripcion').val() || '';
            $('#caracteresCount').text(descripcion.length);
            $('#resumenCaracteres').text(descripcion.length);
        }

        function actualizarProgreso() {
            let camposCompletados = 0;
            const totalCampos = 4;

            if ($('#Titulo').val() && $('#Titulo').val().trim()) camposCompletados++;
            if ($('#TipoProblema').val() && $('#TipoProblema').val().trim()) camposCompletados++;
            if ($('#Prioridad').val() && $('#Prioridad').val().trim()) camposCompletados++;
            if ($('#Descripcion').val() && $('#Descripcion').val().trim()) camposCompletados++;

            const porcentaje = Math.round((camposCompletados / totalCampos) * 100);

            $('#formProgress').css('width', porcentaje + '%');
            $('#progressText').text(porcentaje + '% completado');

            const progressBar = $('#formProgress');
            progressBar.removeClass('bg-danger bg-warning bg-success');
            if (porcentaje < 50) {
                progressBar.addClass('bg-danger');
            } else if (porcentaje < 100) {
                progressBar.addClass('bg-warning');
            } else {
                progressBar.addClass('bg-success');
            }
        }

        function actualizarResumen() {
            const titulo = $('#Titulo').val() || '';
            const tipoProblema = $('#TipoProblema').val() || '';
            const prioridad = $('#Prioridad').val() || '';
            const descripcion = $('#Descripcion').val() || '';

            const tieneDatos = titulo.trim() && tipoProblema && prioridad && descripcion.trim();

            if (tieneDatos) {
                $('#resumenCard').show();
                $('#resumenTitulo').text(titulo || '-');
                $('#resumenTipo').text(tipoProblema || '-');
                $('#resumenPrioridad').text(prioridad || '-');
            } else {
                $('#resumenCard').hide();
            }
        }

        // === SISTEMA DE NOTIFICACIONES MODALES ===
        function showLoadingModal(message = 'Procesando solicitud...') {
            $('#loadingModalMessage').text(message);
            $('#loadingModal').modal('show');
        }

        function hideLoadingModal() {
            $('#loadingModal').modal('hide');
        }

        function showSuccessModal(title, message, autoClose = false) {
            $('#successModalIcon').removeClass('text-danger bi-exclamation-triangle-fill text-warning bi-exclamation-triangle-fill')
                                 .addClass('text-success bi-check-circle-fill');
            $('#successModalButton').removeClass('btn-danger btn-warning').addClass('btn-success');
            $('#successModalTitle').text(title);
            $('#successModalMessage').text(message);
            $('#successModal').modal('show');

            if (autoClose) {
                setTimeout(() => {
                    if ($('#successModal').is(':visible')) {
                        $('#successModal').modal('hide');
                    }
                }, 3000);
            }
        }

        function showErrorModal(title, message, autoClose = true) {
            $('#successModalIcon').removeClass('text-success bi-check-circle-fill text-warning bi-exclamation-triangle-fill')
                                 .addClass('text-danger bi-exclamation-triangle-fill');
            $('#successModalButton').removeClass('btn-success btn-warning').addClass('btn-danger');
            $('#successModalTitle').text(title);
            $('#successModalMessage').text(message);
            $('#successModal').modal('show');

            if (autoClose) {
                setTimeout(() => {
                    if ($('#successModal').is(':visible')) {
                        $('#successModal').modal('hide');
                    }
                }, 4000);
            }
        }
    </script>

    <style>
        /* Tus estilos existentes se mantienen igual */
        .form-floating > .form-control:focus ~ label,
        .form-floating > .form-control:not(:placeholder-shown) ~ label {
            color: #0d6efd;
            font-weight: 600;
        }

        .progress {
            background-color: #e9ecef;
        }

        #resumenCard {
            transition: all 0.3s ease;
        }

        .form-text ul {
            padding-left: 1.2rem;
            margin-bottom: 0.5rem;
        }

        .form-text li {
            margin-bottom: 0.2rem;
        }

        .is-invalid {
            border-color: #dc3545 !important;
        }

        /* Estilos para los modales */
        #successModal .modal-content,
        #loadingModal .modal-content {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        #successModal .modal-body,
        #loadingModal .modal-body {
            padding: 2.5rem;
        }

        #loadingModal .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        #loadingModal .spinner-border {
            border-width: 0.3em;
        }

        .modal.fade .modal-dialog {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            transform: scale(0.8);
            opacity: 0;
        }

        .modal.show .modal-dialog {
            transform: scale(1);
            opacity: 1;
        }
    </style>
}